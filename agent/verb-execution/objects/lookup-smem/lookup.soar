sp {lookup-smem*propose*lookup
   (state <s> ^name lookup-smem
              ^retrieval-count <c>)
-->
   (<s> ^operator <o> +)
   (<o> ^name lookup
        ^category smem)
}

# Remove the query from the smem.command link
sp {lookup-smem*apply*lookup*remove*query
   (state <s> ^name lookup-smem
              ^operator.name lookup
              ^smem <smem>)
   (<smem> ^command <cmd>
           ^result.success <query>)
   (<o> ^name lookup
        ^query <query>)
   (<cmd> ^query <query>)
-->
   (<cmd> ^query <query> -)
}

# If it failed on the first retrieval copy a failure
sp {lookup-smem*apply*lookup*copy*failure
   (state <s> ^name lookup-smem
              ^operator.name lookup
              ^smem.result.failure
              ^retrieval-count 0)
-->
   (<s> ^result failure)
}

# Case 2:  success
sp {lookup-smem*apply*lookup*success*copy-result
   (state <s> ^name lookup-smem
              ^operator.name lookup
              ^smem.result <smem-result>
              ^desired <d>
              ^superstate.operator <ss-op>)
   (<d> ^<att> <v>)
   (<smem-result> ^success
                  ^retrieved.<att> <result>)
-->
   (<s> ^result <result>)
}

# Increment the retrieval counter if success
sp {lookup-smem*apply*lookup*success*increment*counter
   (state <s> ^name lookup-smem
              ^operator.name lookup
              ^smem.result.success
              ^retrieval-count <c>)
-->
   (<s> ^retrieval-count <c> -
        ^retrieval-count (+ <c> 1))
}