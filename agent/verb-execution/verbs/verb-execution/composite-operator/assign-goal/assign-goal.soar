## create the ^desired attribute in the composite operator state
## if the operator is associated with a long-term id corresponding to the goal, retrieve the children.
## if no children are retrieved, pose a 'goal-query'

### elaborate assign-goal
sp {assign-goal*elaborate*state
   (state <s> ^name assign-goal
   	      ^superstate.operator <sop>)
   (<sop> ^name assign-goal
   	  ^long-term-id <glid>
	  ^superoperator <iop>) 
-->
  (<s> ^long-term-id <glid>
       ^desired <d>
       ^superoperator <iop>
       ^bit flip
       ^predicate-count 0
       ^nbit flip)
#  (force-learn <s>) 
}

### retrieve the long-term-id corresponding to the goal of the indexed-operator
sp {assign-goal*retrieve*long-term-id
   (state <s> ^name assign-goal
   	      ^long-term-id <glid>
	      ^smem.command <scom>)
-->
   (<scom> ^retrieve <glid>)
}

### if there is no predicate attribute on the goal id, no goal is known, begin an interaction
sp {assign-goal*unknown-goal
   (state <s> ^name assign-goal
   	      ^long-term-id <glid>
	      ^smem.result <sres>
	      ^topstate <ts>
	      ^quiescence t)
   (<sres> ^success <glid>) ## correctly retrieved
   (<glid> -^<predicate> <any>) ## no predicates in goal
   (<ts> ^status <stat>)
-->
   (<stat> ^type unknown-goal)
}

### create the desired attribute on the state
sp {assign-goal*propose*retrieve-predicate
   (state <s> ^name assign-goal
   	      ^long-term-id <glid>
	      ^smem.result <sres>
	      -^retrieved-success <p1>)
   (<sres> ^success <glid>)
   (<glid> ^<prep> <p1>)
-->
   (<s> ^operator <op> + =)
   (<op> ^name retrieve-predicate
   	 ^predicate <p1>)
}

# sp {assign-goal*elaborate*retrieve-predicate*count
#    (state <s> ^name assign-goal
#    	      ^operator <op> +
# 	      ^predicate-count <count>)
#    (<op> ^name retrieve-predicate)
# -->
#    (<op> ^predicate-count <count>)
# }


# sp {assign-goal*count*predicates
#    (state <s> ^name assign-goal
# 	      ^operator <op>)
#    (<op> ^name retrieve-predicate
#     	 ^predicate-count <count>)
# -->
#    (<s> ^predicate-count (+ 1 <count>)
# )
# }

sp {assign-goal*propose*count-predicates
   (state <s> ^name assign-goal
   	      ^retrieved-success <p>
	      ^predicate-count <pcount>
	      ^nbit flip
	      -^counted <p>)
-->
   (<s> ^operator <op> + =)
   (<op> ^name update-count
	 ^predicate <p>)
}

sp {assign-goal*apply*count-predicate
   (state <s> ^name assign-goal
   	      ^operator <op>
	      ^predicate-count <count>)
   (<op> ^name update-count
   	 ^predicate <p>)
-->
  (<s> ^predicate-count <count> -
       ^predicate-count (+ <count> 1)
       ^counted <p>)
}



sp {elaborate*desired*predicate*count
   (state <s> ^name assign-goal
   	      ^predicate-count <count>
	      ^desired <d>)
 -->
   (<d> ^count <count>)
}


### if state-no-change, write desired to the superstate
sp {assign-goal*write*superstate*desired
   (state <s> ^impasse no-change
   	      ^attribute state
	      ^superstate <ss>)
   (<ss> ^name assign-goal
   	 ^superstate <sss>
	 ^desired <d>)
-->
   (<sss> ^desired <d>)
}
